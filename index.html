<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>3D Interactive Walking & Cycling Trails</title>

    <!-- Preconnect to Cesium CDN for better performance -->
    <link rel="preconnect" href="https://cesium.com">
    <link rel="preconnect" href="https://api.cesium.com">

    <!-- Cesium CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
            font-family: sans-serif; background: #000;
        }
        #toolbar {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(42, 42, 42, 0.8); padding: 10px; border-radius: 5px;
        }
        .trail-info {
            color: white; margin: 5px 0;
        }
        .button {
            background: #007bff; color: white; border: none; padding: 8px 12px;
            margin: 2px; border-radius: 4px; cursor: pointer;
        }
        .button:hover {
            background: #0056b3;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 18px; z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer">
        <div id="loading">Loading 3D Trail Viewer...</div>
        <div id="toolbar">
            <div class="trail-info">
                <strong>Lilydale to Warburton Rail Trail</strong><br>
                Interactive 3D Trail Visualization
            </div>
            <button class="button" onclick="toggleTrails()">Toggle Trails</button>
            <button class="button" onclick="flyToTrails()">View Trails</button>
            <button class="button" onclick="toggleWaypoints()">Toggle Waypoints</button>
        </div>
    </div>

    <!-- Load Cesium BEFORE any other scripts -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>

    <script>
        // =============================================================================
        // ION ACCESS TOKEN (Required Component a)
        // =============================================================================
        Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkOTJmYzRiYi1jNDIxLTQ5NWQtYTJlNC1mMTM0YzZiOGIyY2EiLCJpZCI6MzI1OTI0LCJpYXQiOjE3NTM2NjgxMDJ9.0g_bqQG-v6HAP66sf-o1jHCozZw_jJ0tYLk9ZiEeFYg";

        // =============================================================================
        // VIEWER SETUP (Required Component b)
        // =============================================================================
        const viewer = new Cesium.Viewer("cesiumContainer", {
            terrainProvider: new Cesium.EllipsoidTerrainProvider(),
            scene3DOnly: true,
            selectionIndicator: false,
            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: false,
            vrButton: false
        });

        // =============================================================================
        // GOOGLE PHOTOREALISTIC 3D TILES - Temporarily disabled for troubleshooting
        // =============================================================================
        // try {
        //     const googleTileset = await Cesium.createGooglePhotorealistic3DTileset();
        //     viewer.scene.primitives.add(googleTileset);
        //     console.log("Google Photorealistic 3D Tiles loaded successfully");
        // } catch (error) {
        //     console.warn("Could not load Google Photorealistic 3D Tiles:", error);
        // }

        // Hide the credit container
        viewer._cesiumWidget._creditContainer.style.display = "none";

        // Enable terrain depth testing for better visualization
        viewer.scene.globe.depthTestAgainstTerrain = true;
        viewer.scene.globe.enableLighting = true;

        // =============================================================================
        // GLOBAL VARIABLES
        // =============================================================================
        let trailDataSource = null;
        let waypointDataSource = null;
        let allEntities = [];

        // =============================================================================
        // LOAD TRAIL DATA (Required Component c - GeoJsonDataSource)
        // =============================================================================
        async function loadTrailData() {
            try {
                console.log("Starting trail data loading...");
                document.getElementById('loading').innerHTML = 'Loading trail data...';

                // Load main trail (Lilydale_to_Warburton_Rail_Trail) - Requirement b: thick white line
                console.log("Loading main trail from asset 3852793...");
                const trailResource = await Cesium.IonResource.fromAssetId(3852793);
                console.log("Trail resource created, loading GeoJSON...");
                trailDataSource = await Cesium.GeoJsonDataSource.load(trailResource, {
                    clampToGround: true,
                    stroke: Cesium.Color.WHITE,
                    strokeWidth: 5, // Thicker line as required
                    fill: Cesium.Color.WHITE.withAlpha(0.3)
                });

                console.log("Trail GeoJSON loaded, adding to viewer...");
                await viewer.dataSources.add(trailDataSource);
                console.log("Main trail loaded successfully, entities:", trailDataSource.entities.values.length);

                // Load waypoints (Lilydale_to_Warburton_Rail_Trail_waypoints)
                console.log("Loading waypoints from asset 3852794...");
                const waypointResource = await Cesium.IonResource.fromAssetId(3852794);
                console.log("Waypoint resource created, loading GeoJSON...");
                waypointDataSource = await Cesium.GeoJsonDataSource.load(waypointResource, {
                    clampToGround: true
                });

                console.log("Waypoint GeoJSON loaded, adding to viewer...");
                await viewer.dataSources.add(waypointDataSource);
                console.log("Waypoints loaded successfully, entities:", waypointDataSource.entities.values.length);

                // Combine all entities for easier management
                allEntities = [...trailDataSource.entities.values, ...waypointDataSource.entities.values];
                console.log("Total entities loaded:", allEntities.length);

                // Apply styling and interactions
                console.log("Applying styling to entities...");
                styleTrailEntities();

                // Zoom to show all trails
                console.log("Zooming to trails...");
                await viewer.zoomTo(trailDataSource);

                console.log("Trail data loading completed successfully!");
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error("Error loading trail data:", error);
                document.getElementById('loading').innerHTML = 'Error loading trails: ' + error.message;
                document.getElementById('loading').style.display = 'block';
            }
        }

        // =============================================================================
        // STYLE TRAIL ENTITIES (Required Component d - entity.point and PointGraphics)
        // =============================================================================
        function styleTrailEntities() {
            console.log("Styling trail entities...");

            // Style trail lines - Requirement b: thick white line clamped to ground
            trailDataSource.entities.values.forEach(function(entity) {
                if (entity.polyline) {
                    entity.polyline.material = Cesium.Color.WHITE; // White color as required
                    entity.polyline.width = 5; // Thick line as required
                    entity.name = "Lilydale to Warburton Rail Trail";

                    // Add description for click interaction
                    entity.description = new Cesium.CallbackProperty(function() {
                        return getTrailDescription(entity);
                    }, false);
                }
            });

            // Style waypoint points - Requirement c: style based on Name attribute
            waypointDataSource.entities.values.forEach(function(entity) {
                if (entity.point) {
                    const waypointName = entity.properties?.name || "Unknown";
                    entity.name = waypointName;

                    // Style based on Name attribute - Updated for actual waypoint names
                    let pointColor = Cesium.Color.YELLOW; // default
                    let pointSize = 10;

                    // Requirement c: Different colors based on waypoint type
                    const nameLower = waypointName.toLowerCase();

                    if (nameLower.includes('car park')) {
                        pointColor = Cesium.Color.GREY;
                        pointSize = 12;
                    } else if (nameLower.includes('toilet')) {
                        pointColor = Cesium.Color.BLUE;
                        pointSize = 12;
                    } else if (nameLower.includes('picnic')) {
                        pointColor = Cesium.Color.GREEN;
                        pointSize = 12;
                    } else if (nameLower.includes('bridge')) {
                        pointColor = Cesium.Color.BROWN;
                        pointSize = 12;
                    } else if (nameLower.includes('cafe')) {
                        pointColor = Cesium.Color.ORANGE;
                        pointSize = 12;
                    } else if (nameLower.includes('hotel')) {
                        pointColor = Cesium.Color.RED;
                        pointSize = 12;
                    } else if (nameLower.includes('station')) {
                        pointColor = Cesium.Color.RED;
                        pointSize = 12;
                    } else if (nameLower.includes('playground')) {
                        pointColor = Cesium.Color.LIME;
                        pointSize = 12;
                    } else if (nameLower.includes('tunnel')) {
                        pointColor = Cesium.Color.DARKGRAY;
                        pointSize = 12;
                    } else if (nameLower.includes('museum')) {
                        pointColor = Cesium.Color.PURPLE;
                        pointSize = 12;
                    } else if (nameLower.includes('water')) {
                        pointColor = Cesium.Color.CYAN;
                        pointSize = 12;
                    } else if (nameLower.includes('information') || nameLower.includes('info')) {
                        pointColor = Cesium.Color.BLUE;
                        pointSize = 12;
                    } else if (nameLower.includes('historical')) {
                        pointColor = Cesium.Color.MAGENTA;
                        pointSize = 12;
                    }

                    // Required Component d: entity.point and PointGraphics
                    entity.point = new Cesium.PointGraphics({
                        pixelSize: pointSize,
                        color: pointColor,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    });

                    // Add label
                    entity.label = new Cesium.LabelGraphics({
                        text: entity.name,
                        font: '12pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -32),
                        show: false
                    });

                    // Add description for click interaction
                    entity.description = new Cesium.CallbackProperty(function() {
                        return getWaypointDescription(entity);
                    }, false);
                }
            });

            console.log("Trail entities styled successfully");
        }

        // =============================================================================
        // TRAIL DESCRIPTION FUNCTIONS
        // =============================================================================
        function getTrailDescription(entity) {
            return `
                <h3>${entity.name || 'Lilydale to Warburton Rail Trail'}</h3>
                <p><strong>Type:</strong> Rail Trail</p>
                <p><strong>Activity:</strong> Walking and Cycling</p>
                <p><strong>Surface:</strong> Sealed path</p>
                <p><strong>Description:</strong> A popular rail trail following the former railway line from Lilydale to Warburton, offering scenic views through the Yarra Valley.</p>
                <p><strong>Length:</strong> Approximately 38 km</p>
                <p><strong>Difficulty:</strong> Easy to Moderate</p>
            `;
        }

        function getWaypointDescription(entity) {
            const properties = entity.properties || {};
            return `
                <h3>${entity.name}</h3>
                <p><strong>Type:</strong> ${properties.type || 'Waypoint'}</p>
                <p><strong>Elevation:</strong> ${properties.elevation ? Math.round(properties.elevation) + 'm' : 'Unknown'}</p>
                <p>${properties.description || 'A point of interest along the trail'}</p>
            `;
        }

        // =============================================================================
        // INTERACTIVE FUNCTIONS
        // =============================================================================
        function toggleTrails() {
            if (trailDataSource) {
                trailDataSource.entities.values.forEach(function(entity) {
                    entity.show = !entity.show;
                });
                console.log("Trails toggled");
            }
        }

        function toggleWaypoints() {
            if (waypointDataSource) {
                waypointDataSource.entities.values.forEach(function(entity) {
                    entity.show = !entity.show;
                });
                console.log("Waypoints toggled");
            }
        }

        function flyToTrails() {
            if (trailDataSource) {
                viewer.flyTo(trailDataSource.entities.values, {
                    offset: new Cesium.HeadingPitchRange(0, -0.5, 0)
                });
            }
        }

        // =============================================================================
        // ENTITY SELECTION AND INFORMATION DISPLAY
        // =============================================================================
        viewer.selectedEntityChanged.addEventListener(function(selectedEntity) {
            // Hide all labels first
            allEntities.forEach(function(entity) {
                if (entity.label) {
                    entity.label.show = false;
                }
            });

            // Show label for selected entity
            if (selectedEntity && selectedEntity.label) {
                selectedEntity.label.show = true;
            }
        });

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing trail application...");
            loadTrailData();
        });

        // =============================================================================
        // ERROR HANDLING
        // =============================================================================
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            document.getElementById('loading').innerHTML = 'Application error: ' + e.error.message;
        });
    </script>
</body>
</html>
