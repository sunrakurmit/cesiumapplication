<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>3D Interactive Walking & Cycling Trails</title>

    <!-- Preconnect to Cesium CDN for better performance -->
    <link rel="preconnect" href="https://cesium.com">
    <link rel="preconnect" href="https://api.cesium.com">

    <!-- Cesium CSS -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
            font-family: sans-serif; background: #000;
        }
        #toolbar {
            position: absolute; top: 10px; left: 10px; z-index: 1000;
            background: rgba(42, 42, 42, 0.8); padding: 10px; border-radius: 5px;
        }
        .trail-info {
            color: white; margin: 5px 0;
        }
        .button {
            background: #007bff; color: white; border: none; padding: 8px 12px;
            margin: 2px; border-radius: 4px; cursor: pointer;
        }
        .button:hover {
            background: #0056b3;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 18px; z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer">
        <div id="loading">Loading 3D Trail Viewer...</div>
        <div id="toolbar">
            <div class="trail-info">
                <strong>Lilydale to Warburton Rail Trail</strong><br>
                Interactive 3D Trail Visualization
            </div>
            <button class="button" onclick="toggleTrails()">Toggle Trails</button>
            <button class="button" onclick="flyToTrails()">View Trails</button>
            <button class="button" onclick="toggleWaypoints()">Toggle Waypoints</button>
        </div>
    </div>

    <!-- Load Cesium BEFORE any other scripts -->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>

    <script>
        // =============================================================================
        // ION ACCESS TOKEN
        // =============================================================================
        Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkOTJmYzRiYi1jNDIxLTQ5NWQtYTJlNC1mMTM0YzZiOGIyY2EiLCJpZCI6MzI1OTI0LCJpYXQiOjE3NTM2NjgxMDJ9.0g_bqQG-v6HAP66sf-o1jHCozZw_jJ0tYLk9ZiEeFYg";

        // =============================================================================
        // VIEWER SETUP
        // =============================================================================
        const viewer = new Cesium.Viewer("cesiumContainer", {
            terrainProvider: new Cesium.EllipsoidTerrainProvider(),
            scene3DOnly: true,
            selectionIndicator: false,
            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            animation: false,
            timeline: false,
            fullscreenButton: false,
            vrButton: false
        });


        // Hide the credit container
        viewer._cesiumWidget._creditContainer.style.display = "none";

        // Enable terrain depth testing for better visualization
        viewer.scene.globe.depthTestAgainstTerrain = true;
        viewer.scene.globe.enableLighting = true;

        // =============================================================================
        // GLOBAL VARIABLES
        // =============================================================================
        let trailDataSource = null;
        let waypointDataSource = null;
        let allEntities = [];

        // =============================================================================
        // LOAD TRAIL DATA
        // =============================================================================
        async function loadTrailData() {
            try {
                console.log("Starting trail data loading...");
                document.getElementById('loading').innerHTML = 'Loading trail data...';

                // Load main trail (Lilydale to Warburton Rail Trail)
                console.log("Loading main trail from asset 3852793...");
                const trailResource = await Cesium.IonResource.fromAssetId(3852793);
                console.log("Trail resource created, loading GeoJSON...");
                trailDataSource = await Cesium.GeoJsonDataSource.load(trailResource, {
                    clampToGround: true,
                    stroke: Cesium.Color.WHITE,
                    strokeWidth: 5, // Thicker line as required
                    fill: Cesium.Color.WHITE.withAlpha(0.3)
                });

                console.log("Trail GeoJSON loaded, adding to viewer...");
                await viewer.dataSources.add(trailDataSource);
                console.log("Main trail loaded successfully, entities:", trailDataSource.entities.values.length);

                // Load waypoints (Lilydale_to_Warburton_Rail_Trail_waypoints)
                console.log("Loading waypoints from asset 3852794...");
                const waypointResource = await Cesium.IonResource.fromAssetId(3852794);
                console.log("Waypoint resource created, loading GeoJSON...");
                waypointDataSource = await Cesium.GeoJsonDataSource.load(waypointResource, {
                    clampToGround: true
                });

                console.log("Waypoint GeoJSON loaded, adding to viewer...");
                await viewer.dataSources.add(waypointDataSource);
                console.log("Waypoints loaded successfully, entities:", waypointDataSource.entities.values.length);

                // Combine all entities for easier management
                allEntities = [...trailDataSource.entities.values, ...waypointDataSource.entities.values];
                console.log("Total entities loaded:", allEntities.length);

                // Apply styling and interactions
                console.log("Applying styling to entities...");
                styleTrailEntities();

                // Zoom to show all trails
                console.log("Zooming to trails...");
                await viewer.zoomTo(trailDataSource);

                console.log("Trail data loading completed successfully!");
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                console.error("Error loading trail data:", error);
                document.getElementById('loading').innerHTML = 'Error loading trails: ' + error.message;
                document.getElementById('loading').style.display = 'block';
            }
        }

        // =============================================================================
        // STYLE TRAIL ENTITIES
        // =============================================================================
        function styleTrailEntities() {
            console.log("Styling trail entities...");

            // Style trail lines
            trailDataSource.entities.values.forEach(function(entity) {
                if (entity.polyline) {
                    entity.polyline.material = Cesium.Color.WHITE;
                    entity.polyline.width = 5;
                    entity.name = "Lilydale to Warburton Rail Trail";

                    // Add description for click interaction
                    entity.description = new Cesium.CallbackProperty(function() {
                        return getTrailDescription(entity);
                    }, false);
                }
            });

            // Style waypoint points
            console.log("Processing waypoint entities...");
            waypointDataSource.entities.values.forEach(function(entity, index) {
                console.log(`Entity ${index}:`, {
                    hasPoint: !!entity.point,
                    hasPolyline: !!entity.polyline,
                    hasPolygon: !!entity.polygon,
                    position: entity.position,
                    properties: entity.properties
                });

                // Check if entity has position (indicates it's a point feature)
                if (entity.position) {
                    console.log(`Entity ${index} has position, creating point geometry`);
                    // Debug: Check what properties are available
                    console.log("Waypoint entity properties:", entity.properties);
                    console.log("Available property names:", entity.properties ? Object.keys(entity.properties._propertyNames || entity.properties) : "No properties");

                    // Try different ways to access the name property
                    let waypointName = "Unknown";

                    if (entity.properties) {
                        // Try different property access patterns - use 'Name' with capital N
                        if (entity.properties.Name) {
                            waypointName = entity.properties.Name;
                        } else if (entity.properties.name) {
                            waypointName = entity.properties.name;
                        } else if (entity.properties._propertyNames) {
                            // Check if 'Name' exists in property names
                            const propNames = entity.properties._propertyNames || [];
                            if (propNames.includes('Name') || propNames.includes('name')) {
                                const nameProp = propNames.find(p => p === 'Name' || p === 'name');
                                waypointName = entity.properties[nameProp] || "Unknown";
                            }
                        }
                    }

                    console.log("Raw waypoint name object:", waypointName);

                    // Extract the actual string value from Cesium Property object
                    const actualWaypointName = waypointName._value || waypointName;
                    console.log("Waypoint name (extracted):", actualWaypointName);
                    entity.name = actualWaypointName;

                    // Style based on waypoint names
                    let pointColor = Cesium.Color.YELLOW; // default
                    let pointSize = 10;

                    // Different colors based on waypoint names
                    if (actualWaypointName === 'Car park') {
                        pointColor = Cesium.Color.GREY;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Picnic table') {
                        pointColor = Cesium.Color.GREEN;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Bridge') {
                        pointColor = Cesium.Color.BROWN;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Long Wooden Bridge') {
                        pointColor = Cesium.Color.BROWN;
                        pointSize = 12;
                    } else if (actualWaypointName.includes('Cafe')) {
                        pointColor = Cesium.Color.ORANGE;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Home Hotel') {
                        pointColor = Cesium.Color.RED;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Historical Information') {
                        pointColor = Cesium.Color.MAGENTA;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Information') {
                        pointColor = Cesium.Color.BLUE;
                        pointSize = 12;
                    } else if (actualWaypointName.includes('Station')) {
                        pointColor = Cesium.Color.RED;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Playground') {
                        pointColor = Cesium.Color.LIME;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Tunnel') {
                        pointColor = Cesium.Color.DARKGRAY;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Upper Yarra Museum') {
                        pointColor = Cesium.Color.PURPLE;
                        pointSize = 12;
                    } else if (actualWaypointName.includes('Toilet')) {
                        pointColor = Cesium.Color.BLUE;
                        pointSize = 12;
                    } else if (actualWaypointName === 'Water (drinking tap)') {
                        pointColor = Cesium.Color.CYAN;
                        pointSize = 12;
                    }

                    // Create point graphics for waypoints
                    console.log("Applying styling - Name:", actualWaypointName, "Color:", pointColor.toCssColorString());

                    // Create point graphics for this waypoint
                    entity.point = new Cesium.PointGraphics({
                        pixelSize: pointSize,
                        color: pointColor,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                    });

                    console.log("Styling applied to entity:", entity.name);
                } else {
                    console.log(`Entity ${index} has no position - skipping`);
                }

                // Add label to all entities (whether they have positions or not)
                if (!entity.label) {
                    entity.label = new Cesium.LabelGraphics({
                        text: entity.name,
                        font: '12pt sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -32),
                        show: false
                    });
                }

                // Add description for click interaction to all entities
                if (!entity.description) {
                    entity.description = new Cesium.CallbackProperty(function() {
                        return getWaypointDescription(entity);
                    }, false);
                }
            });

            console.log("Trail entities styled successfully");
        }

        // =============================================================================
        // TRAIL DESCRIPTION FUNCTIONS
        // =============================================================================
        function getTrailDescription(entity) {
            return `
                <h3>${entity.name || 'Lilydale to Warburton Rail Trail'}</h3>
                <p><strong>Type:</strong> Rail Trail</p>
                <p><strong>Activity:</strong> Walking and Cycling</p>
                <p><strong>Surface:</strong> Sealed path</p>
                <p><strong>Description:</strong> A popular rail trail following the former railway line from Lilydale to Warburton, offering scenic views through the Yarra Valley.</p>
                <p><strong>Length:</strong> Approximately 38 km</p>
                <p><strong>Difficulty:</strong> Easy to Moderate</p>
            `;
        }

        function getWaypointDescription(entity) {
            const properties = entity.properties || {};
            return `
                <h3>${entity.name}</h3>
                <p><strong>Type:</strong> ${properties.type || 'Waypoint'}</p>
                <p><strong>Elevation:</strong> ${properties.elevation ? Math.round(properties.elevation) + 'm' : 'Unknown'}</p>
                <p>${properties.description || 'A point of interest along the trail'}</p>
            `;
        }

        // =============================================================================
        // INTERACTIVE FUNCTIONS
        // =============================================================================
        function toggleTrails() {
            if (trailDataSource) {
                trailDataSource.entities.values.forEach(function(entity) {
                    entity.show = !entity.show;
                });
                console.log("Trails toggled");
            }
        }

        function toggleWaypoints() {
            if (waypointDataSource) {
                waypointDataSource.entities.values.forEach(function(entity) {
                    entity.show = !entity.show;
                });
                console.log("Waypoints toggled");
            }
        }

        function flyToTrails() {
            if (trailDataSource) {
                viewer.flyTo(trailDataSource.entities.values, {
                    offset: new Cesium.HeadingPitchRange(0, -0.5, 0)
                });
            }
        }

        // =============================================================================
        // ENTITY SELECTION AND INFORMATION DISPLAY
        // =============================================================================
        viewer.selectedEntityChanged.addEventListener(function(selectedEntity) {
            // Hide all labels first
            allEntities.forEach(function(entity) {
                if (entity.label) {
                    entity.label.show = false;
                }
            });

            // Show label for selected entity
            if (selectedEntity && selectedEntity.label) {
                selectedEntity.label.show = true;
            }
        });

        // =============================================================================
        // INITIALIZATION
        // =============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing trail application...");
            loadTrailData();
        });

        // =============================================================================
        // ERROR HANDLING
        // =============================================================================
        window.addEventListener('error', function(e) {
            console.error('Application error:', e.error);
            document.getElementById('loading').innerHTML = 'Application error: ' + e.error.message;
        });
    </script>
</body>
</html>

